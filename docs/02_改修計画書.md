# 改修計画書（2人対戦対応・Firebase移行）

最終更新: 2025-09-11

## 1. 背景と目的

- 現行は 1 人プレイのみのデモ SPA（フロントのみ）。
- 目標は画面 UI をできる限り共通のまま、1 人/2 人プレイを切替可能にすること。
- 2 人プレイは Firebase（Auth/Firestore/Functions/Cloud Tasks）を用いたオンライン対戦を採用。
- 初回は最小実装でデプロイし、段階的に機能拡張する。

## 2. スコープ

- 対象
  - 1 人/2 人プレイ切替の導入。
  - Firebase Hosting への移行（現行 SPA をそのまま配信）。
  - 2 人プレイに必要なロビー/ドラフト進行のバックエンド（最小）。
  - ドラフト進行の抽象化（1P/2Pで実装差し替えできる構造）。
- 非対象（後続）
  - 観戦機能（当面は未対応）。
  - 通信断からの復帰（当面は未対応。断時はゲーム終了）。
  - 本番向けの包括的監視/分析、課金や認証強化。

## 3. ゴール（フェーズ別）

- フェーズ0: Firebase Hosting へ移行
  - ゴール: 現行 1 人プレイ SPA を Firebase Hosting で配信可能。
  - 成果物: `firebase.json`, `.firebaserc`、ビルド/デプロイ手順。
- フェーズ1: ドラフト状態の抽象化（ローカル実装）
  - ゴール: `DraftController` 抽象を導入し、1P はローカル実装で動作。
  - 成果物: 型・フック（`useDraftControllerLocal`）、既存 UI の接続差し替え。
- フェーズ2: 2P ロビー UI（モック）
  - ゴール: ロビー作成/席URL共有/着席/準備完了 UI の骨組み（ローカルモック）。
  - 成果物: 画面遷移（Home/Lobby/Draft）、最低限の状態表示。
- フェーズ3: Firebase クライアント統合（最小）
  - ゴール: 匿名 Auth と Firestore の購読でロビー表示がリアルデータで動く。
  - 成果物: Firebase 初期化、`onSnapshot` の購読、開発用 Emulator 対応。
- フェーズ4: ロビー作成〜ドラフト開始（sequence_01 準拠）
  - ゴール: `createRoom`/`claimSeat`/`setReady`/`startDraft` が通り、BAN1 開始。
  - 成果物: Functions（TS）最小実装、Firestore モデル、Cloud Tasks タイムアウト予約。
- フェーズ5: ドラフト進行（sequence_02 準拠・完走）
  - ゴール: `applyAction` による合法検証→状態遷移→次ターン→`deadline` 更新が最後まで回る。
  - 成果物: 進行ロジック（サーバ側）、クライアントの UI 連動（ハイライト/残秒表示）。
- フェーズ6: 通信断＝ゲーム終了（簡易）
  - ゴール: 断を検知/宣言した時点で `state=aborted`（復帰なし）。
  - 成果物: 簡易 Leave 操作・状態、クライアントの終了表示。
- フェーズ7: 1P/2P 統合整備
  - ゴール: 同一 UI で 1P/2P を切替運用。実装差し替えのみで機能同等。
  - 成果物: 共通型整理、ガード/エッジケースの補強、簡易ドキュメント。
- フェーズ8（先送り）: 観戦/再接続/本番強化
  - ゴール: 観戦者購読、再接続、セキュリティ/レート制限/GC など強化。

## 4. アーキテクチャ方針

- UI 共通 + 進行制御のアダプタ化
  - `DraftController` 抽象（例）
    - 取得: `state`（phase, turn, deadline, bans, picks, lastAction）
    - 入力: `select`, `confirm`, `confirmPair`, `start`, `leave` など
  - 実装
    - 1P: 既存ロジックを `useDraftControllerLocal` へ移植。
    - 2P: Firebase 連動 `useDraftControllerRemote`（購読 + Functions 呼び出し）。
- データモデル（Firestore `rooms/{roomId}` 概要）
  - `seats`: `{ PURPLE: {seatKey, uid?, displayName?, ready?}, ORANGE: {...} }`
  - `state`: `{ phase, turnTeam, turnIndex, deadline, bans, picks, lastAction }`
  - `config`: `{ turnSeconds: 15, autoStart?: boolean }`
  - `createdAt`, `updatedAt`, `version`
- Functions（2nd gen / TypeScript）
  - `createRoom(config?)` → rooms 作成・席キー払い出し
  - `claimSeat(roomId, seatKey, displayName)` → 着席
  - `setReady(roomId)` → 準備完了
  - `startDraft(roomId)` → state 初期化 + タイムアウト予約
  - `applyAction(roomId, action)` → 合法性検証 + 進行
  - `onTurnTimeout(roomId, turnIndex)` → タイムアウト自動選出 + 次ターン
- タイムアウト設計
  - `deadline` を Firestore に保存し、クライアントは残秒をクライアント時計で算出。
  - サーバは Cloud Tasks で `onTurnTimeout` を予約し、期限到来で処理の正を担保。
- セキュリティ（概要）
  - Auth: 匿名サインイン（uid）を必須。
  - ルール: `rooms/{roomId}` は着席者のみ書込可、読み取りは着席者＋（将来）観戦。
  - Functions 側でも seatKey/uid の整合性検証。

## 5. 画面仕様（最小）

- Home
  - 1 人プレイ / 2 人プレイを選択。
- Lobby（2P）
  - ロビー作成、席 URL 表示/コピー、着席、準備完了、相手の状態表示。
- Draft
  - 現行 UI を踏襲（`TeamPanel`/`CandidateGrid`）。
  - 現在ターンのハイライト、残り時間表示。

## 6. テスト戦略

- 単体: 進行ロジック（合法性、ターン遷移、タイムアウト）。
- 結合: Functions + Firestore（Emulator Suite）。
- E2E: 2 ブラウザセッションでの進行（Emulator 使用）。
- パフォーマンス/信頼性: タイムアウト連鎖、遅延・同時操作の競合（悲観/楽観制御）。

## 7. 運用・デプロイ

- Hosting: Vite ビルド成果物 `frontend/dist` を配信。
- 環境: `dev`/`prod` プロジェクトを分離（`.firebaserc` で切替）。
- ワークフロー（最小）
  - `npm ci && npm run build`（frontend）
  - `firebase deploy --only hosting`（フェーズ0）
  - 以降のフェーズでは `functions` と `firestore:rules` も追加デプロイ。

## 8. 受け入れ条件（DoD）

- フェーズ0
  - Hosting で SPA が配信・動作する（1P プレイ完走）。
- フェーズ1
  - 1P が `DraftController` 抽象で同等動作し、UI/操作は現行と同等。
- フェーズ2
  - ロビー UI が一通り操作可能（モック状態）。
- フェーズ3
  - 匿名 Auth、Firestore 購読でロビー状態がリアルタイム反映。
- フェーズ4
  - 両者 ready → ドラフト開始 → BAN1 の期限表示と進行開始。
- フェーズ5
  - 最後の PICK まで完走。タイムアウトで自動選出が機能。
- フェーズ6
  - 通信断/Leave で `aborted` 終了となり、以降操作不可。
- フェーズ7
  - 1P/2P を UI から切替運用可能。回帰不具合がない。

## 9. タスク分解（概略）

- 設定/基盤
  - Hosting 設定ファイル追加（`firebase.json`, `.firebaserc`）
  - Firebase 初期化（SDK, env, emulator 切替）
- フロント
  - ルーティング導入（Home/Lobby/Draft）
  - `DraftController` 抽象（型/フック）+ Local 実装
  - Remote 実装（購読・操作・残秒計算）
- バックエンド（Functions）
  - ルーム管理 API（create/claim/setReady）
  - 進行 API（startDraft/applyAction/onTurnTimeout）
  - 合法性検証/Tx 更新/タイムアウト予約
- テスト
  - Emulator Suite セットアップ
  - 進行ロジックの単体/結合/E2E

## 10. リスクと対策

- 時計差/遅延: `deadline` に対するクライアント残秒は目安。正はサーバの Cloud Tasks で担保。
- 同時操作競合: Firestore Tx と idempotency を徹底。`turnIndex` を比較検証。
- 画像ホスティング依存: 外部画像の 404/遅延。必要に応じてキャッシュ/代替画像を検討。
- 切断検知の難しさ: 当面は手動 Leave のみ。将来は Realtime Database presence 等で補強。

## 11. 参照ドキュメント

- 要件定義: `docs/01_要件定義書.md`
- シーケンス: `docs/sequence_01_ロビー作成_ドラフト開始.md`, `docs/sequence_02_ドラフト1ターン目.md`

---

本計画に基づき、フェーズ 0（Hosting 移行）から順次着手する。各フェーズ完了時に DoD を満たすことを確認し、次フェーズへ進む。

