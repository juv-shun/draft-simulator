# 改修計画書（2人対戦対応・Firebase移行）

最終更新: 2025-09-11

## 1. 背景と目的

- 現行は 1 人プレイのみのデモ SPA（フロントのみ）。
- 目標は画面 UI をできる限り共通のまま、1 人/2 人プレイを切替可能にすること。
- 2 人プレイは Firebase（Auth/Firestore/Functions/Cloud Tasks）を用いたオンライン対戦を採用。
- 初回は最小実装でデプロイし、段階的に機能拡張する。

## 2. スコープ

- 対象
  - 1 人/2 人プレイ切替の導入。
  - Firebase Hosting への移行（現行 SPA をそのまま配信）。
  - 2 人プレイに必要なロビー/ドラフト進行のバックエンド（最小）。
  - ドラフト進行の抽象化（1P/2Pで実装差し替えできる構造）。
- 非対象（後続）
  - 観戦機能（当面は未対応）。
  - 通信断からの復帰（当面は未対応。断時はゲーム終了）。
  - 本番向けの包括的監視/分析、課金や認証強化。

## 3. ゴール（フェーズ別）

- フェーズ0: Firebase Hosting へ移行
  - ゴール: 現行 1 人プレイ SPA を Firebase Hosting で配信可能。
  - 成果物: `firebase.json`, `.firebaserc`、ビルド/デプロイ手順。
- フェーズ1: ドラフト状態の抽象化（ローカル実装）
  - ゴール: `DraftController` 抽象を導入し、1P はローカル実装で動作。
  - 成果物: 型・フック（`useDraftControllerLocal`）、既存 UI の接続差し替え。
- フェーズ2: 2P ロビー UI（モック）
  - ゴール: ロビー作成/部屋URL共有/着席 UI の骨組み（ローカルモック）。
  - 成果物: 画面遷移（Home/Lobby/Draft）、最低限の状態表示。
- フェーズ3: Firebase クライアント統合（最小）
  - ゴール: 匿名 Auth と Firestore の購読でロビー表示がリアルデータで動く。
  - 成果物: Firebase 初期化、`onSnapshot` の購読、開発用 Emulator 対応。
- フェーズ4: ロビー作成〜ドラフト開始（sequence_01 準拠）
  - ゴール: `createRoom`/`claimSeat`/`startDraft` が通り、BAN1 開始。
  - 成果物: Functions（TS）最小実装、Firestore モデル、Cloud Tasks タイムアウト予約。
  - 付帯: クライアント直書き（開発用）は廃止。以降は Functions 経由に統一。
- フェーズ5: ドラフト進行（sequence_02 準拠・完走）
  - ゴール: `applyAction` による合法検証→状態遷移→次ターン→`deadline` 更新が最後まで回る。
  - 成果物: 進行ロジック（サーバ側）、クライアントの UI 連動（ハイライト/残秒表示）。
- フェーズ6: 通信断＝ゲーム終了（簡易）
  - ゴール: 断を検知/宣言した時点で `state=aborted`（復帰なし）。
  - 成果物: 簡易 Leave 操作・状態、クライアントの終了表示。
- フェーズ7: 1P/2P 統合整備
  - ゴール: 同一 UI で 1P/2P を切替運用。実装差し替えのみで機能同等。
  - 成果物: 共通型整理、ガード/エッジケースの補強、簡易ドキュメント。
- フェーズ8（先送り）: 観戦/再接続/本番強化
  - ゴール: 観戦者購読、再接続、セキュリティ/レート制限/GC など強化。

## 4. アーキテクチャ方針

- UI 共通 + 進行制御のアダプタ化
  - `DraftController` 抽象（例）
    - 取得: `state`（phase, turn, deadline, bans, picks, lastAction）
    - 入力: `select`, `confirm`, `confirmPair`, `start`, `leave` など
  - 実装
    - 1P: 既存ロジックを `useDraftControllerLocal` へ移植。
    - 2P: Firebase 連動 `useDraftControllerRemote`（購読 + Functions 呼び出し）。
- データモデル（Firestore `rooms/{roomId}` 概要）
  - `seats`: `{ PURPLE: { uid?, displayName? }, ORANGE: { uid?, displayName? } }`
  - `state`: `{ phase, turnTeam, turnIndex, deadline, bans, picks, lastAction }`
  - `config`: `{ turnSeconds: 15, autoStart?: boolean }`
  - `createdAt`, `updatedAt`, `version`
  - `hostUid`: ルーム作成者の `uid`（ホスト権限の判定に使用。作成後は不変）
- Functions（2nd gen / TypeScript）
  - `createRoom(config?)` → rooms 作成（`hostUid = request.auth.uid` を必須で設定）
  - `claimSeat(roomId, team, displayName)` → 着席（teamは`PURPLE|ORANGE`）
  - `startDraft(roomId)` → state 初期化 + タイムアウト予約（呼び出しはホストのみ許可）
  - `applyAction(roomId, action)` → 合法性検証 + 進行
  - `onTurnTimeout(roomId, turnIndex)` → タイムアウト自動選出 + 次ターン
- タイムアウト設計
  - `deadline` を Firestore に保存し、クライアントは残秒をクライアント時計で算出。
  - サーバは Cloud Tasks で `onTurnTimeout` を予約し、期限到来で処理の正を担保。
- セキュリティ（概要）
  - Auth: 匿名サインイン（uid）を必須。
  - ルール: フェーズ4以降、`rooms/{roomId}` のクライアント書込は禁止（read のみ許可）。書込は Functions（Admin SDK）のみ。
  - Functions 側でも uid と着席チームの整合性を検証。
  - ホスト権限: `hostUid` は作成時に設定し、その後は不変。`startDraft` 等の操作は `request.auth.uid == hostUid` のみ許可。
  - 実行タイミング: 匿名サインインは2人プレイ時のみ、ロビー作成・参加などの操作直前に実施（1人プレイではサインイン不要）。

## 5. 画面仕様（最小）

- Home
  - 1 人プレイ / 2 人プレイを選択。
- Lobby（2P）
  - ロビー作成、部屋URL表示/コピー、着席、相手の状態表示。
- Draft
  - 現行 UI を踏襲（`TeamPanel`/`CandidateGrid`）。
  - 現在ターンのハイライト、残り時間表示。

## 6. テスト戦略

- 単体: 進行ロジック（合法性、ターン遷移、タイムアウト）。
- 結合: Functions + Firestore（Emulator Suite）。
- E2E: 2 ブラウザセッションでの進行（Emulator 使用）。
- パフォーマンス/信頼性: タイムアウト連鎖、遅延・同時操作の競合（悲観/楽観制御）。

## 7. 運用・デプロイ

- Hosting: Vite ビルド成果物 `frontend/dist` を配信。
- 環境: `dev`/`prod` プロジェクトを分離（`.firebaserc` で切替）。
- ワークフロー（最小）
  - `npm ci && npm run build`（frontend）
  - `firebase deploy --only hosting`（フェーズ0）
  - 以降のフェーズでは `functions` と `firestore:rules` も追加デプロイ。

## 8. 受け入れ条件（DoD）

- フェーズ0
  - Hosting で SPA が配信・動作する（1P プレイ完走）。
- フェーズ1
  - 1P が `DraftController` 抽象で同等動作し、UI/操作は現行と同等。
- フェーズ2
  - ロビー UI が一通り操作可能（モック状態、準備完了なし）。
- フェーズ3
  - 匿名 Auth、Firestore 購読でロビー状態がリアルタイム反映。
- フェーズ4
  - 両席着席 → ドラフト開始 → BAN1 の期限表示と進行開始。
- フェーズ5
  - 最後の PICK まで完走。タイムアウトで自動選出が機能。
- フェーズ6
  - 通信断/Leave で `aborted` 終了となり、以降操作不可。
- フェーズ7
  - 1P/2P を UI から切替運用可能。回帰不具合がない。

## 9. タスク分解（概略）

- 設定/基盤
  - Hosting 設定ファイル追加（`firebase.json`, `.firebaserc`）
- Firebase 初期化（SDK, env, emulator 切替）
  - 開発環境では必ず Emulator を使用（`VITE_USE_EMULATORS=true` を必須化）
- フロント
  - ルーティング導入（Home/Lobby/Draft）
  - `DraftController` 抽象（型/フック）+ Local 実装
  - Remote 実装（購読・操作・残秒計算）
- バックエンド（Functions）
  - ルーム管理 API（create/claim）
  - 進行 API（startDraft/applyAction/onTurnTimeout）
  - 合法性検証/Tx 更新/タイムアウト予約
- テスト
  - Emulator Suite セットアップ
  - 進行ロジックの単体/結合/E2E

## 10. リスクと対策

- 時計差/遅延: `deadline` に対するクライアント残秒は目安。正はサーバの Cloud Tasks で担保。
- 同時操作競合: Firestore Tx と idempotency を徹底。`turnIndex` を比較検証。
- 画像ホスティング依存: 外部画像の 404/遅延。必要に応じてキャッシュ/代替画像を検討。
- 切断検知の難しさ: 当面は手動 Leave のみ。将来は Realtime Database presence 等で補強。

## 11. 参照ドキュメント

- 要件定義: `docs/01_要件定義書.md`
- シーケンス: `docs/sequence_01_ロビー作成_ドラフト開始.md`, `docs/sequence_02_ドラフト1ターン目.md`

---

本計画に基づき、フェーズ 0（Hosting 移行）から順次着手する。各フェーズ完了時に DoD を満たすことを確認し、次フェーズへ進む。

## 12. フェーズ5 実装計画（ドラフト進行・完走）

- 目的: Functions 側でドラフト進行の正（合法性検証/状態遷移/タイムアウト）を担保し、フロントは購読と操作のみで最後まで完走できるようにする。

### 12.1 サーバ機能（Functions）

- 新規関数
  - `applyAction(roomId, action)`
    - 概要: 呼び出しユーザーの着席チームを特定し、現在ターンに対する操作の合法性を検証し、次の状態へ遷移する。
    - リクエスト: `{ roomId: string, action: { kind: 'ban' | 'pick', ids: string[] } }`
    - レスポンス: `{ ok: true, turnIndex: number, deadline: number, state: Partial<State> }`
    - 主要バリデーション:
      - 認証必須・着席済みであること。
      - 現在の `state.phase/turnTeam/turnIndex` と呼び出しが整合すること（自チームのターンであること）。
      - `action.kind` とフェーズ整合（ban_phase なら `ban`、pick_phase なら `pick`）。
      - `ids.length` がターン定義に合致（シングル/ペア）。
      - すでに `bans/picks` 済みの ID と重複していないこと、`ids` 同士が重複していないこと。
      - （暫定）ID は functions 側の `pokemons.json` 許可リストに含まれること。
    - 状態更新（Tx 内）：
      - `bans` または `picks` に反映。
      - `lastAction` を更新。
      - 次のターンを計算して `phase/turnTeam/turnIndex` を更新。
      - `deadline = now + turnSeconds * 1000` を更新（最終ターン完了時は `phase='finished'`、`turnTeam/turnIndex/deadline` を `null/未設定`）。
      - `updatedAt` 更新。
      - 競合対策: 読み出し時の `turnIndex` を保持し、更新時に `where turnIndex === expected` をロジックで厳格チェック（Tx 内で再検証）。
  - `onTurnTimeout(roomId, turnIndex)`
    - 概要: 期限切れ時に Cloud Tasks から呼ばれ、合法なランダム選出で自動確定し、次ターンへ遷移する。
    - バリデーション: 現在の `turnIndex` が一致し、まだ確定していない場合のみ処理（冪等）。
    - ランダム選出: 残存候補から `ids` を必要数選ぶ。`lastAction.by` にターン側チームを記録。
    - 次ターンが存在する場合は新 `deadline` 設定と次回タスクを再予約。

- 既存関数の拡張
  - `startDraft(roomId)`
    - 変更: `deadline` 設定後に `onTurnTimeout(roomId, 1)` を Cloud Tasks で予約。
    - 予約失敗時: エラーログ出力しつつ呼び出しには成功を返す（Emulator/開発環境考慮）。

- Cloud Tasks 設計
  - キュー: `draft-timeouts`（リージョン `us-central1`）。
  - タスク名: `room-{roomId}-turn-{turnIndex}`（重複投入抑止）。
  - 予約遅延: `deadline - now + safetyMs(=500)`。
  - 冪等性: `turnIndex` 不一致や `phase` 不整合は no-op。

- データ/ユーティリティ
  - `functions/src/data/pokemons.json`（暫定コピー）: ID 許可リスト。
  - `functions/src/rooms/engine.ts`（新規）: 
    - ターン定義と次ターン計算 `nextTurn(state): { phase, team, index } | finished`。
    - 合法性チェック `validateAction(state, team, action, idsAllowed)`。
    - 自動選出 `pickRandom(state, n, prefer?)`。

### 12.2 ターン定義（順序と入力個数）

- 使用禁止フェーズ1（ban1）
  - 1: PURPLE ban ×1
  - 2: ORANGE ban ×1
  - 3: PURPLE ban ×1
  - 4: ORANGE ban ×1
- 使用ポケモン選択フェーズ1（pick1）
  - 5: PURPLE pick ×1
  - 6: ORANGE pick ×2（同時）
  - 7: PURPLE pick ×2（同時）
  - 8: ORANGE pick ×1
- 使用禁止フェーズ2（ban2）
  - 9: PURPLE ban ×1
  - 10: ORANGE ban ×1
- 使用ポケモン選択フェーズ2（pick2）
  - 11: ORANGE pick ×1
  - 12: PURPLE pick ×2（同時）
  - 13: ORANGE pick ×1（最終）

※ 実装上は `phase: 'ban1'|'pick1'|'ban2'|'pick2'` と `turnTeam/turnIndex` の組み合わせで表現。`turnIndex` は 1 始まりでもグローバル通番でも可（既存に合わせて 1 始まり + phase/チームで識別）。

### 12.3 合法性検証（抜粋）

- 共通
  - 自チームのターンであること（`seats[team].uid === request.auth.uid`）。
  - `ids.length` がターン定義に一致（1 または 2）。
  - 各 `id` は許可リストに存在し、`bans`/`picks` に未登場であること。
  - `ids` 同士の重複禁止。
- BAN
  - `action.kind === 'ban'`、対象スロットが空であること。
- PICK（シングル/ペア）
  - `action.kind === 'pick'`、対象スロットが空であること。
  - ペアの場合は 2 体とも同時に確保（いずれか確保済みならエラー）。

### 12.4 同時実行制御と冪等性

- すべて Firestore Tx 内で実施し、Tx 開始時に現在の `phase/turnIndex/turnTeam` を読み取り、適用直前に再検証。
- `applyAction` は `turnIndex` をレスポンスに含め、クライアントは差異があれば UI を最新化する。
- `onTurnTimeout` は `turnIndex` が一致しない場合は no-op で成功扱い（多重呼び出し耐性）。

### 12.5 フロントエンド変更

- API ラッパー
  - `apiApplyAction(roomId, kind, ids)` を追加。
- Draft 画面（2P/Remote）
  - `rooms/{roomId}` の `state.deadline` から残秒を算出し表示（0 で赤点滅など）。
  - `state.turnTeam` が自チームの場合のみ操作可能。それ以外は候補を Disabled。
  - シングル/ペアの入力 UI は既存ローカル実装の仕様に準拠（ハイライト/confirm ボタン）。
  - エラー表示（重複/不正）の簡易トースト。
- 共通 UI
  - 現在フェーズ/ターンのハイライトを `highlights` 相当のロジックで算出（Remote はサーバ状態から導出）。

### 12.6 テスト計画

- 単体（engine.ts）
  - 各フェーズの合法/不正ケース、重複/順序違反、ペア選択の相互排他、次ターン遷移の網羅。
- 結合（Functions + Firestore Emulator）
  - `startDraft` → `applyAction` 連鎖で最終ターンまで完走。
  - タイムアウト: `deadline` を短縮して `onTurnTimeout` 呼び出しで自動選出が進むこと。
  - 競合: 2 クライアント同時 `applyAction` の片方が弾かれること（Tx で正しく整合）。
- E2E（手動/自動）
  - 2 ブラウザでロビー→ドラフト→完走、残秒/ハイライト表示確認。

### 12.7 運用/移行

- Cloud Tasks のキュー作成とデプロイ設定（`firebase.json`/`functions` のキュー定義）。
- `firestore.rules` は現状の「書込禁止」方針を維持（Functions のみが書込）。
- 既存データの互換: `version:1` 前提を維持し、フィールド追加は後方互換に配慮。

### 12.8 タスク一覧（実装順）

1) engine 実装（ターン定義/検証/次ターン算出）
2) `applyAction` 実装（Tx/検証/状態更新/deadline 更新）
3) `onTurnTimeout` 実装（自動選出/次ターン/再予約）
4) `startDraft` にタスク予約追加
5) `pokemons.json` の functions 側配置と参照
6) フロントに `apiApplyAction` 追加 + Remote 用 UI ハンドラ
7) 残秒/ハイライト表示のリモート対応（ローカルと共通化可能なら共通化）
8) Emulator 結合テストスクリプト整備（最小）
9) ドキュメント更新（この節/手順の微修正、エラーコード一覧）

### 12.9 受け入れ条件（フェーズ5）

- 2P 対戦で、BAN1 → PICK1 → BAN2 → PICK2 の全 13 ターンを完走。
- 任意ターンでのタイムアウト時に自動選出で進行し、以降のターンも正しく継続。
- 不正入力（他人のターン、重複 ID、無効 ID、長さ不一致）に対してエラーを返し状態が変化しない。
- フロントで残秒とハイライトが正しく表示され、操作可否が適切に制御される。
